# RoboMaster 一键操作控制器

![License](https://img.shields.io/badge/License-GPLv3-blue.svg)
![MCU](https://img.shields.io/badge/MCU-STM32F103-blue)
![IDE](https://img.shields.io/badge/IDE-STM32CubeIDE-blue)

---

## 项目概述

本项目是一个基于 STM32 微控制器的硬件控制器，用于在 **RoboMaster** 比赛中自动化完成游戏客户端内的一系列 UI 交互操作（如快速购买弹药、买活等）。通过物理按键触发，模拟发送精确的键鼠操作序列，实现“一键完成”，极大提升操作手在紧张比赛中的效率与可靠性。

---

## 功能特性

- **一键触发**：物理按键映射特定游戏内操作。
- **精准模拟**：通过串口协议模拟鼠标移动、点击和键盘按键。
- **抗抖动处理**：软件去抖动与边缘检测，防止误触发。
- **高度可配置**：所有 UI 坐标、延时参数均通过宏定义灵活设置。
- **强兼容性**：基于 STM32HAL 库开发，易于移植到其他 STM32 型号。

---

## 硬件组成 (BOM)

| 部件       | 规格/型号       | 备注                         |
|------------|------------------|------------------------------|
| 主控芯片   | STM32F103C8T6    | 核心控制器                   |
| 通信接口   | TTL 转 RS232 模块 | 连接电脑 DB9 口              |
| 电平转换   | MAX3232 等 RS232 芯片 |                            |
| 按键       | 轻触开关         | 若干                         |
| 电源       | 3.7V 锂电池      | 配合充放电模块               |
| 其他       | LED 指示灯、电阻、电容等 |                        |

---

## 软件架构

### 开发环境

- **IDE**: STM32CubeIDE
- **编译器**: ARM-GCC
- **调试器**: ST-Link（可选）
- **核心库**: STM32HAL 库

### 程序架构

采用 **轮询 (Polling) + 有限状态机 (FSM)** 的主循环架构，无需 RTOS，资源占用低，响应实时。

```text
主循环 (Main Loop)
│
├── 扫描按键状态 (Scan Keys)
├── 防抖动处理 (Debounce)
├── 下降沿检测？ --是--> 触发状态机 (Trigger FSM)
│   │
│   ├── 发送键盘指令 (Send Key)
│   ├── 执行鼠标序列 (Send Mouse Sequence)
│   └── 执行公共确认序列 (Send Common Sequence)
│
└── 重置标志位，等待下次触发
```

## 快速开始

### 1. 获取源码
\`\`\`bash
git clone <https://github.com/sr-wrcr/rm2025--automatic-bullet-exchanger.git>
\`\`\`

### 2. 导入并编译工程
1. 使用 STM32CubeIDE 打开本项目根目录
2. 根据您的具体硬件，可能需要使用 STM32CubeMX (\`.ioc\`文件) 重新配置引脚（如UART端口）
3. 点击项目 -> Build All 进行编译

### 3. 烧录程序
使用ST-Link、J-Link或USB转TTL工具，通过SWD接口将编译生成的 \`.elf\` 或 \`.bin\` 文件烧录至STM32单片机

### 4. 硬件连接
1. 将控制器的 \`UART_TX\` 引脚连接至 **RS232电平转换模块** 的 \`TXD_IN\`
2. 将RS232模块的 **DB9公头** 连接至操作手电脑的 **DB9母口**（或通过RS232转USB线连接）
3. **确保共地(GND)**

### 5. 参数配置（关键步骤）
在 \`main.h\` 或 \`config.h\` 文件中找到参数配置区，根据您的客户端设置修改以下宏定义：

\`\`\`c
// UI坐标配置 (示例，必须校准)
#define BUY_BTN_X        650
#define BUY_BTN_Y        480
#define CONFIRM_BTN_X    960
#define CONFIRM_BTN_Y    540

// 延时配置 (单位: ms)
#define UI_RESPONSE_DELAY_MS    70
#define DEBOUNCE_DELAY_MS       20

// 串口配置
#define UART_HANDLE            &huart1
#define COMM_BAUDRATE          115200
\`\`\`

#### 坐标校准方法：
1. 在比赛用的电脑上，以**比赛分辨率**和**缩放比例(必须100%)** 运行RoboMaster客户端
2. 使用可显示鼠标坐标的软件（如Snipaste），将鼠标悬停在需要点击的按钮上
3. 记录下屏幕坐标，并更新到代码的宏定义中

### 6. 使用
1. 为控制器供电
2. 按下按键，触发预设的操作序列

## 协议说明
本项目通信协议完全遵循《RoboMaster裁判系统串口协议》，数据帧格式如下：

| 帧头(5B) | 数据长度(2B) | 帧ID(2B) | 自定义数据(n B) | CRC8(1B) |
| :--- | :--- | :--- | :--- | :--- |
| \`0xA5\` ... |  | \`0x0306\` |  |  |

自定义数据包结构体定义详见 \`referee.h\` 中的 \`custom_client_data_t\`

## 故障排除 (FAQ)

| 问题现象 | 可能原因 | 解决方案 |
| :--- | :--- | :--- |
| **指令完全无响应** | 1. 电源未接通<br>2. 串口线缆故障<br>3. 波特率不匹配<br>4. 驱动问题 | 1. 检查供电和开关<br>2. 尝试更换线缆（推荐FTDI芯片线）<br>3. 确认电脑与单片机波特率一致<br>4. 检查设备管理器中COM口状态 |
| **点击位置不准** | 1. 坐标配置错误<br>2. 屏幕分辨率/缩放比例变更 | 1. 重新校准坐标<br>2. 确保电脑显示设置与校准时间一致 |
| **按键一次触发多次操作** | 软件去抖动延时不足 | 增大 \`DEBOUNCE_DELAY_MS\` 的值 |

**高级调试**：若问题依旧，可使用**USB转TTL模块**（需3.3V电平）连接MCU的\`UART_TX\`和GND，在PC端使用串口助手（如CoolTerm、Putty）监听数据输出，判断控制器是否正常发送数据

## 开源协议

本项目采用 **GNU General Public License v3.0 (GPL-3.0)** 开源协议。这意味着您可以自由地使用、修改和分发本代码，但任何基于本项目的衍生作品也必须以相同的许可证进行开源。

详情请参阅项目根目录下的 [LICENSE](LICENSE) 文件。

## 免责声明

本项目为RoboMaster参赛队的技术交流与学习而开发。请确保您的使用符合《RoboMaster竞赛规则》的最新规定。开发者不对因使用本项目而可能产生的任何规则风险或比赛判罚负责。

## 贡献与联系

欢迎提交 Issue 和 Pull Request来共同改进这个项目。

如有问题，可通过以下方式联系：
- 邮箱：[1231001020@cnu.edu.cn]

---
**祝您比赛顺利，登顶冠军！**
